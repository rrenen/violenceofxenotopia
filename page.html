<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title></title>

<script src="https://widget.cloudinary.com/v2.0/global/all.js"></script>

<style>
@font-face {
  font-family: 'EurostileNextExtBold';
  src: url('fonts/eurostile-bold-extended.otf') format('opentype');
}

:root {
  --font-sans: 'EurostileNextExtBold', sans-serif;
}

body {
  font-family: var(--font-sans);
  margin: 40px auto;
  max-width: 700px;
}

h1 { border-bottom: 2px solid #ccc; }

#content {
  border: 1px solid #ccc;
  padding: 1em;
  min-height: 200px;
}

#content img,
#content video {
  max-width: 90%;
  display: block;
  margin: 15px auto;
  cursor: pointer;
}

button { margin-top: 1em; }
</style>
</head>

<body>

<h1 id="pageTitle"></h1>

<div id="editControls" style="display:none;">
  <button onclick="insertInlineMedia()">Insert Media</button>
</div>

<div id="content" contenteditable="false"></div>

<div id="saveControls" style="display:none;">
  <button onclick="saveContent()">Save</button>
  <button onclick="deletePage()">üóë Delete Page</button>
</div>

<p><a href="index.html">‚Üê Back</a></p>

<script>
const cloudName = "dmnwfksrm";
const uploadPreset = "unsigned";

const title = new URLSearchParams(location.search).get("page");
const isEditMode = localStorage.getItem("wikiEditMode") === "on";

pageTitle.textContent = title;
document.title = title;

content.innerHTML =
  localStorage.getItem("wikiPage:" + title) || "";

if (isEditMode) {
  content.contentEditable = true;
  editControls.style.display = "block";
  saveControls.style.display = "block";
  enableInlineDelete();
}

/* ===== Cloudinary ===== */
function openUploader(cb) {
  cloudinary.openUploadWidget({
    cloudName,
    uploadPreset,
    resourceType: "auto"
  }, (_, res) => {
    if (res.event === "success") cb(res.info.secure_url);
  });
}

function insertInlineMedia() {
  openUploader(url => {
    const el = document.createElement(
      url.match(/\.(mp4|mov|webm)$/) ? "video" : "img"
    );
    el.src = url;
    if (el.tagName === "VIDEO") el.controls = true;
    window.getSelection().getRangeAt(0).insertNode(el);
    saveContent();
    enableInlineDelete();
  });
}

/* ===== inline delete ===== */
function enableInlineDelete() {
  content.querySelectorAll("img, video").forEach(el => {
    el.onclick = e => {
      if (!isEditMode) return;
      if (confirm("Delete this media?")) {
        el.remove();
        saveContent();
      }
      e.stopPropagation();
    };
  });
}

/* ===== save ===== */
function saveContent() {
  localStorage.setItem("wikiPage:" + title, content.innerHTML);
}

/* ===== delete page (‚òÖ index.html „Å®ÂÆåÂÖ®ÈÄ£Âãï) ===== */
function deletePage() {
  if (!confirm("Delete this page completely?")) return;

  localStorage.removeItem("wikiPage:" + title);
  localStorage.removeItem("wikiPageMedia:" + title);

  let pages = JSON.parse(localStorage.getItem("wikiPages") || "[]");
  pages = pages.filter(p => p.title !== title);
  localStorage.setItem("wikiPages", JSON.stringify(pages));

  location.href = "index.html";
}
</script>

</body>
</html>
